rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================================================================
    // HELPER FUNCTIONS
    // =========================================================================

    // Check if the user is authenticated (logged in)
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if the user has true 'admin' role from their user profile
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // =========================================================================
    // COLLECTION RULES
    // =========================================================================

    // -------------------------------------------------------------------------
    // Users Collection
    // Profiles for Students and Admins (Authenticated Users)
    // -------------------------------------------------------------------------
    match /users/{userId} {
      // Users can read/update their own profile. Admins can manage all.
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow delete: if isAdmin();
    }

    // -------------------------------------------------------------------------
    // Faculty Collection
    // -------------------------------------------------------------------------
    match /faculty/{facultyId} {
      // PUBLIC READ REQUIRED:
      // The current Faculty Login system uses a custom ID/Password check against 
      // this collection WITHOUT signing into Firebase Auth first. 
      // Therefore, they are "unauthenticated" guests.
      allow read: if true;
      
      // Only Admins (who are authenticated) can create/edit faculty.
      allow write: if isAdmin();
    }

    // -------------------------------------------------------------------------
    // Subjects Collection (Timetables)
    // -------------------------------------------------------------------------
    match /{path=**}/subjects/{subjectId} {
      // PUBLIC READ REQUIRED:
      // Since Faculty are not signed into Firebase Auth, they cannot pass an 
      // isAuthenticated() check. Use 'true' to allow them to view schedules.
      allow read: if true;
      
      // Only Admins can manage subjects.
      allow write: if isAdmin();
    }

    // -------------------------------------------------------------------------
    // Audit Logs
    // -------------------------------------------------------------------------
    match /audit_logs/{logId} {
      allow read, create: if isAdmin();
      allow update, delete: if false; // Immutable
    }
  }
}
